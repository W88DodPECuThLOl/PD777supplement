# μPD777のアセンブラ

# これは何？
μPD777というののアセンブラです。

# ビルド方法
1. asm777.slnを開き
2. ビルドします

# 使い方

    asm777 入力ファイル 出力ファイル

## 入力ファイル
テキスト形式のアセンブラファイルです。  
拡張子はasm777を推奨します。

## 出力ファイル
アセンブルされたバイナリ形式のファイルです。  
拡張子はbin777を推奨します。

### 出力ファイルの形式

ヘッダー部分 + バイナリ部分で構成されています。

#### ヘッダー部分

| Offset | Size |   | 説明 |
|---|---|---|---|
| +0x00 |  16  | MagicNumber   | マジックナンバー |
| +0x10 |  4  | FormatVersion | フォーマットのバージョン '0000' |
| +0x14 |  4  | Padding1      | 未使用。0固定 |
| +0x18 |  8  | KeyMap[8]     | キーマップ |
| +0x20 | 224 | Title         | タイトル<br>0終端のUTF8の文字列 |


##### マジックナンバー

16文字で_CassetteVision_

##### フォーマットのバージョン

4文字で0000

##### キーマップ

カセットの入力部分がどこに配線されているかの設定です。  
A8～A12をμPD777のS1～S4に割り当てます。

| カセットのピン  |   |  説明 |
|---|---|---|
| A8 | KeyMap[0] | START、レバースイッチ1R、レバースイッチ1L、SELECT、AUX | 
| A9 | KeyMap[1] | レバースイッチ2R、レバースイッチ2L |
| A10 | KeyMap[2] | Push4、Push3 |
| A11 | KeyMap[3] | Push2、Push1 | 
| A12 | KeyMap[4] | コーススイッチ |

※KeyMap[5]～KeyMap[7]は未使用、0にする。

S1～S4は、1～4で。  
割り当てが不明なら全部0で。

例）Pakpak Monster  
Push1～Push4のボタンが個別に割り当てられていて、  
START、レバースイッチ1R、レバースイッチ1L、SELECTも使える。  
※レバースイッチ2R、レバースイッチ2L、コーススイッチは、未割り当てで取得できない

    KeyMap[0] = 1; // A8にS1を割り当て
    KeyMap[1] = 0; // A9は未割り当て（接続されていない）
    KeyMap[2] = 2; // A10にS2を割り当て
    KeyMap[3] = 1; // A11にS1を割り当て
    KeyMap[4] = 0; // A12は未割り当て（接続されていない）

例）Galaxian  
コーススイッチ以外、全てS1に割り当てられている。  
Push4とPush2、Push3とPush1、レバースイッチ1とレバースイッチ2は同じ入力になる。

    KeyMap[0] = 1; // A8にS1を割り当て
    KeyMap[1] = 1; // A9にS1を割り当て
    KeyMap[2] = 1; // A10にS1を割り当て
    KeyMap[3] = 1; // A11にS1を割り当て
    KeyMap[4] = 0; // A12は未割り当て（接続されていない）

#### バイナリ部分

アドレス(16bit)とコード(16bit)が交互に並んだものです。  
数値は、リトルエンディアンで格納されています。

読む込むときは、アドレスの所に、コードを設定する感じになります。

    u16 buffer[];
    for(適切なループ範囲) {
        auto address = buffer[i + 0];
        auto code    = buffer[i + 1];
        rom[address] = code;
    }

# アセンブラについて

* 基本的に「777 Design Note」の「µPD777 Instruction Table」に沿っています。
* 「;」以降は行末までコメントになります
* 英字から始まり「:」で終わるものはラベルとなります。  
  ラベルは行頭に書きます。
* 表記中の一部の記号などは変更しています。  
  例)  
  「H→NRM」は「H=>NRM」  
  「H⇔X」は「H<=>X」  
  「A1・A2」は「A1&A2」  
  「A1∨A2」は「A1|A2」
* Judgeは、ニーモニックの前に記述します。  
  例)  
  CAJ  M-K  
  EQJ/ A2=A1, $0=>L
* 数値は、16進数のみで、$を付けて1桁から3桁。  
  例)  
  $12=>A1  
  $7F=>L,H  
  $2=>L

サンプル

            TITLE   "SAMPLE"
            
            KEY_MAP A8 =>S1
            KEY_MAP A10=>S2
            KEY_MAP A11=>S1
    
    ; =========================================
    ; スタートアップ部分
    ; -----------------------------------------
    COLD:
            NOP
    ; システムレジスタ初期化
            $0=>D, $0=>G, $0=>K, $0=>S, $0=>A11
    ; 音停止
            $1F=>L,H    ; K<$1F> => L<0>,H<$1F>
            $01=>M
            M=>FLS, $0=>L
            M=>FRS, $1=>L
    ; レジスタ初期化
            $00=>A1
            $00=>A2
            $00=>A3
            $00=>A4
            H<=>X
    ; メモリを0クリア
            $1F=>L,H    ; K<$1F> => L<0>,H<$1F>
    MemoryClearLoop:
            A=>MA
        BOJ H-$01=>H
            JP MemoryClearLoop
    ; STB初期化(入力モード)
            $1=>STB
            $1=>STB
            $1=>STB
            $1=>STB
    ; モードレジスタ初期化
            A1=>MODE, $2=>L
    ; NRMクリア
            JS  NRM_CLEAR
            JS  NRM_CLEAR
    ; プログラム部分へジャンプ
            $0=>D, $0=>G, $0=>K, $0=>S, $1=>A11
    
    ; -----------------------------------------
    ; NRMクリア
    ; -----------------------------------------
    NRM_CLEAR:
            $3F=>L,H                        ; K<$3F> => L<1>,H<$1F>
    ; 4H BLK待ち
    NRM_Clear4HBLK_WaitLoop:
        J   4H BLK
            JP  NRM_Clear4HBLK_WaitLoop
    ; 0x1FをNRMに書き込んでクリア
    NRM_Clear_Loop:
            H=>NRM
        CAJ M+$08=>M, $1=>L
            JP  NRM_Clear_Loop
            SRE
    
    ; -----------------------------------------
    ; スタートアップ部分 ここまで
    ; =========================================
    
    
    ; =========================================
    ; プログラムのエントリ
    ; =========================================
            ORG $46B
    PROG_ENTRY:
    MAIN_LOOP:
            JP  MAIN_LOOP

## 疑似命令

| 命令 | 説明 | 例 |
|-----|-----|----|
| ORG $数値3桁 | コードアドレスを設定。  | ORG $46B |
| KEY_MAP ピンの番号=>割り当てるSTB | キーの割り当てを行う。<br>ピンの番号: A8,A9,A10,A11,A12<br>割り当てるSTB: S1,S2,S3,S4  | KEY_MAP A8=>S1<br>KEY_MAP A10=>S2 |
| TITLE 文字列 | バイナリにタイトルを埋め込む  | TITLE "BALLON DEMO" |
