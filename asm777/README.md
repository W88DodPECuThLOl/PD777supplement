# μPD777のアセンブラ

# これは何？
μPD777というののアセンブラです。

# ビルド方法
1. asm777.slnを開き
2. ビルドします

# 使い方

    asm777 入力ファイル 出力ファイル

## 入力ファイル
テキスト形式のアセンブラファイルです。  
拡張子はasm777を推奨します。

## 出力ファイル
アセンブルされたバイナリ形式のファイルです。  
拡張子はbin777を推奨します。

### 出力ファイルの形式

ヘッダー部分 + バイナリ部分で構成されています。

#### ヘッダー部分

| Offset | Size |   | 説明 |
|---|---|---|---|
| +0x00 |  16  | MagicNumber   | マジックナンバー |
| +0x10 |  4  | FormatVersion | フォーマットのバージョン '0001' |
| +0x14 |  4  | Padding1      | 未使用。0固定 |
| +0x18 |  8  | KeyMapA[8]    | キーマップA |
| +0x20 |  8  | KeyMapB[8]    | キーマップB |
| +0x28 | 216 | Title         | タイトル<br>0終端のUTF8の文字列 |


##### マジックナンバー

16文字で_CassetteVision_

##### フォーマットのバージョン

4文字で0001

##### キーマップA

カセットの入力部分がどこに配線されているかの設定。  
A8～A12をμPD777のS1～S4に割り当てる。

| カセットのピン  |   |  説明 |
|---|---|---|
| A8 | KeyMapA[0] | START、レバースイッチ1R、レバースイッチ1L、SELECT、AUX | 
| A9 | KeyMapA[1] | レバースイッチ2R、レバースイッチ2L |
| A10 | KeyMapA[2] | Push4、Push3 |
| A11 | KeyMapA[3] | Push2、Push1 | 
| A12 | KeyMapA[4] | コーススイッチ |

※KeyMapA[5]～KeyMapA[7]は未使用、0にすること。

S1～S4は、1～4で。  
割り当てが不明なら全部0に。

※特殊な設定
　+4でデジタル入力の上を0x40に割り当てる  
　+4でデジタル入力の下を0x20に割り当てる  
　+8でレバー1左を0x40に割り当てる  
　+8でレバー1右を0x20に割り当てる  

例）Galaxian  
コーススイッチ以外、全てS1に割り当てられている。  
Push4とPush2、Push3とPush1、レバースイッチ1とレバースイッチ2は同じ入力になる。

    KeyMapA[0] = 1; // A8にS1を割り当て
    KeyMapA[1] = 1; // A9にS1を割り当て
    KeyMapA[2] = 1; // A10にS1を割り当て
    KeyMapA[3] = 1; // A11にS1を割り当て
    KeyMapA[4] = 0; // A12は未割り当て（接続されていない）

##### キーマップB

カセットの入力部分がどこに配線されているかの設定。  
B9～B15をμPD777のK1～K7に割り当てる。

| カセットのピン  |   | デフォルト | 説明 |
|---|---|---|---|
| B9  | KeyMapB[0] | 0x40(K7) | B9がONの時に設定するKの値  |
| B10 | KeyMapB[1] | 0x20(K6) | B10がONの時に設定するKの値 |
| B11 | KeyMapB[2] | 0x10(K5) | B11がONの時に設定するKの値 |
| B12 | KeyMapB[3] | 0x08(K4) | B12がONの時に設定するKの値 |
| B13 | KeyMapB[4] | 0x04(K3) | B13がONの時に設定するKの値 |
| B14 | KeyMapB[5] | 0x02(K2) | B14がONの時に設定するKの値 |
| B15 | KeyMapB[6] | 0x01(K1) | B15がONの時に設定するKの値 |

※KeyMapB[7]は未使用、0にすること。  
※Kは、「K=>M」命令のKで、メモリに書き込まれる値。

例）Pakpak Monster  
Push1～Push4のボタンが個別に割り当てられていて、START、レバースイッチ1R、レバースイッチ1L、SELECTも使える。  
※レバースイッチ2R、レバースイッチ2L、コーススイッチは、未割り当てで取得できない  
Kの入力先が変更されていて、K1～K3に再割り当てされている。

    KeyMapA[0] = 1; // A8にS1を割り当て  
    KeyMapA[1] = 0; // A9は未割り当て（接続されていない）  
    KeyMapA[2] = 2 | (1 << 2); // A10にS2を割り当て UPをPUSH3、DOWNをPUSH4に割り当てる  
    KeyMapA[3] = 1 | (2 << 2); // A11にS1を割り当て レバー1左右をPUSH1、PUSH2に割り当てる  
    KeyMapA[4] = 0; // A12は未割り当て（接続されていない）
    
    // K
    KeyMapB[0] = 0x02;           // B09 => K2
    KeyMapB[1] = 0x04;           // B10 => K3
    KeyMapB[2] = 0x00;           // B11
    KeyMapB[3] = 0x08;           // B12 => K4
    KeyMapB[4] = 0x00;           // B13
    KeyMapB[5] = 0x00;           // B14
    KeyMapB[6] = 0x01;           // B15 => K1

#### バイナリ部分

アドレス(16bit)とコード(16bit)が交互に並んだものです。  
数値は、リトルエンディアンで格納されています。

読む込むときは、アドレスの所に、コードを設定する感じになります。

    u16 buffer[];
    for(適切なループ範囲) {
        auto address = buffer[i + 0];
        auto code    = buffer[i + 1];
        rom[address] = code;
    }

# アセンブラについて

* 基本的に「777 Design Note」の「µPD777 Instruction Table」に沿っています。
* 「;」以降は行末までコメントになります
* 英字から始まり「:」で終わるものはラベルとなります。  
  ラベルは行頭に書きます。
* 表記中の一部の記号などは変更しています。  
  例)  
  「H→NRM」は「H=>NRM」  
  「H⇔X」は「H<=>X」  
  「A1・A2」は「A1&A2」  
  「A1∨A2」は「A1|A2」
* Judgeは、ニーモニックの前に記述します。  
  例)  
  CAJ  M-K  
  EQJ/ A2=A1, $0=>L
* 数値は、16進数のみで、$を付けて1桁から3桁。  
  例)  
  $12=>A1  
  $7F=>L,H  
  $2=>L

サンプル

            TITLE   "SAMPLE"
            
            KEY_MAP A8 =>S1
            KEY_MAP A10=>S2
            KEY_MAP A11=>S1
    
    ; =========================================
    ; スタートアップ部分
    ; -----------------------------------------
    COLD:
            NOP
    ; システムレジスタ初期化
            $0=>D, $0=>G, $0=>K, $0=>S, $0=>A11
    ; 音停止
            $1F=>L,H    ; K<$1F> => L<0>,H<$1F>
            $01=>M
            M=>FLS, $0=>L
            M=>FRS, $1=>L
    ; レジスタ初期化
            $00=>A1
            $00=>A2
            $00=>A3
            $00=>A4
            H<=>X
    ; メモリを0クリア
            $1F=>L,H    ; K<$1F> => L<0>,H<$1F>
    MemoryClearLoop:
            A=>MA
        BOJ H-$01=>H
            JP MemoryClearLoop
    ; STB初期化(入力モード)
            $1=>STB
            $1=>STB
            $1=>STB
            $1=>STB
    ; モードレジスタ初期化
            A1=>MODE, $2=>L
    ; NRMクリア
            JS  NRM_CLEAR
            JS  NRM_CLEAR
    ; プログラム部分へジャンプ
            $0=>D, $0=>G, $0=>K, $0=>S, $1=>A11
    
    ; -----------------------------------------
    ; NRMクリア
    ; -----------------------------------------
    NRM_CLEAR:
            $3F=>L,H                        ; K<$3F> => L<1>,H<$1F>
    ; 4H BLK待ち
    NRM_Clear4HBLK_WaitLoop:
        J   4H BLK
            JP  NRM_Clear4HBLK_WaitLoop
    ; 0x1FをNRMに書き込んでクリア
    NRM_Clear_Loop:
            H=>NRM
        CAJ M+$08=>M, $1=>L
            JP  NRM_Clear_Loop
            SRE
    
    ; -----------------------------------------
    ; スタートアップ部分 ここまで
    ; =========================================
    
    
    ; =========================================
    ; プログラムのエントリ
    ; =========================================
            ORG $46B
    PROG_ENTRY:
    MAIN_LOOP:
            JP  MAIN_LOOP

## 疑似命令

| 命令 | 説明 | 例 |
|-----|-----|----|
| ORG $数値3桁 | コードアドレスを設定。  | ORG $46B |
| KEY_MAP ピンの番号=>割り当てるSTB | キーの割り当てを行う。<br>ピンの番号: A8,A9,A10,A11,A12<br>割り当てるSTB: S1,S2,S3,S4  | KEY_MAP A8=>S1<br>KEY_MAP A10=>S2 |
| KEY_MAP ピンの番号=>Kの値 | キーの割り当てを行う。<br>ピンの番号: B9,B10,B11,B12,B13,B14,B15<br>割り当てるKの値: $00～$7F | KEY_MAP B9=>$10<br>KEY_MAP B10=>$04 |
| TITLE 文字列 | バイナリにタイトルを埋め込む  | TITLE "BALLON DEMO" |
